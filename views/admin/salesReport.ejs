<%- include('./adminHeader.ejs') %>

<div class="col-lg-6 grid-margin stretch-card" style="width: 90%;">
    <div class="card">
        <div class="card-body">
            <div class="filters mb-3">
                <form action="/admin/FilterSalesReport" method="GET">
                    <div class="form-group" style="width: 23%;">
                        <label for="salesPeriod">Sales Period</label>
                        <select id="salesPeriod" name="salesPeriod" class="form-control" style="color: aliceblue;">
                            <option value="Select">Select</option>
                            <option value="Daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    
                    <div class="form-group row" style="width: 100%;">
                        <div class="col-md-6 d-flex align-items-center">
                            <div class="form-group mr-3">
                                <label for="startDate">Start Date</label>
                                <input type="date" id="startDate" name="startDate" class="form-control">
                            </div>&nbsp;
                            <div class="form-group mr-3">
                                <label for="endDate">End Date</label>
                                <input type="date" id="endDate" name="endDate" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6 d-flex justify-content-end align-items-center">
                            <a href="#" class="btn btn-secondary ml-2" id="downloadPdfBtn">Download PDF</a>&nbsp;
                            <a href="#" class="btn btn-secondary ml-2" id="downloadExcelBtn">Download Excel</a>
                        </div>
                    </div>
                
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                    </div>
                </form>
                
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Products</th>
                            <th>Total Quantity</th>
                            <th>Customer Name</th>
                            <th>Payment Method</th>
                            <th>Total Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% sales.forEach(sale => { %>
                            <tr>
                                <td><%= new Date(sale.createdAt).toLocaleDateString() %></td>
                                <td>
                                    <% sale.orderItems.forEach((item, index) => { %>
                                        <%= item.product.name %> x <%= item.quantity %>
                                        <%= index < sale.orderItems.length - 1 ? ', ' : '' %>
                                    <% }) %>
                                </td>
                                <td>
                                    <% 
                                        let totalQuantity = 0;
                                        sale.orderItems.forEach(item => {
                                            totalQuantity += item.quantity;
                                        });
                                    %>
                                    <%= totalQuantity %>
                                </td>
                                <td><%= sale.user.name %></td>
                                <td><%= sale.paymentMethod %></td>
                                <td><%= sale.amount.toFixed(2) %></td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
<script>
    document.getElementById("downloadPdfBtn").addEventListener("click", function () {
        let doc = new window.jspdf.jsPDF();
        let pageCenter = doc.internal.pageSize.getWidth() / 2;

        doc.setFontSize(25);
        doc.text("G BAGS.", pageCenter, 10, { align: 'center' });
        doc.setFontSize(15);
        doc.text("Sales Report", pageCenter, 20, { align: 'center' });

        let table = document.querySelector(".table");

        doc.autoTable({ html: table, startY: 35 });

        doc.save("SalesReport.pdf");
    });
    document.getElementById("downloadExcelBtn").addEventListener("click", function () {
        let workbook = XLSX.utils.book_new();

        let table = document.querySelector(".table");

        let worksheet = XLSX.utils.table_to_sheet(table);

        XLSX.utils.book_append_sheet(workbook, worksheet, "Sales Report");

        let range = XLSX.utils.decode_range(worksheet['!ref']);
        for (let C = range.s.c; C <= range.e.c; ++C) {
            let max_width = 0;
            for (let R = range.s.r; R <= range.e.r; ++R) {
                let cell_address = { c: C, r: R };
                let cell_ref = XLSX.utils.encode_cell(cell_address);
                if (!worksheet[cell_ref]) continue;
                let cell_width = XLSX.SSF.format(cell_address, worksheet[cell_ref].v).length;
                max_width = Math.max(max_width, cell_width);
            }
            worksheet['!cols'] = worksheet['!cols'] || [];
            worksheet['!cols'][C] = { wch: max_width + 1 };
        }

        XLSX.writeFile(workbook, "Sales Report.xlsx", { bookSST: true, type: 'binary'});
        });
</script>

<%- include('./adminFooter.ejs') %>
