<%- include('./adminHeader.ejs') %>


<div class="container">
    <div class="card">
        <div class="card-body">
            <h4 class="card-title">Order Details</h4>
            <div class="order-info">
                <p><strong>Order ID:</strong> <%= order.orderRefId %></p>
                <p><strong>User:</strong> <%= order.user ? order.user.name : 'N/A' %></p>
                <p><strong>Ordered Date:</strong> <%= new Date(order.createdAt).toLocaleDateString() %></p>
                <p><strong>Shipping Address:</strong> 
                    <%= order.shippingAddress ? `${order.shippingAddress.street}, ${order.shippingAddress.city}, ${order.shippingAddress.state}, ${order.shippingAddress.zipcode}, ${order.shippingAddress.country}` : 'N/A' %>
                </p>
                <p><strong>Payment Method:</strong> <%= order.paymentMethod %></p>
                <p><strong>return status:</strong> <%= order.returnStatus %></p>
                <p><strong>return reason:</strong> <%= order.returnReason%></p>
                <form action="/admin/updateOrderStatus" method="POST">
                    <p><strong>Status:</strong>
                        <select name="orderStatus" class="form-control" style="width: 150px;color: aliceblue;" required>
                            <% if(order.orderStatus !== 'delivered' && order.orderStatus !== 'Canceled' && order.orderStatus !== 'order returned') {%>
                            <option value="pending" style="color: aliceblue;" <%= order.orderStatus === 'pending' ? 'selected' : '' %>>Pending</option>
                            <option value="shipped" style="color: aliceblue;" <%= order.orderStatus === 'shipped' ? 'selected' : '' %>>Shipped</option>
                            <option value="delivered" style="color: aliceblue;" <%= order.orderStatus === 'delivered' ? 'selected' : '' %>>Delivered</option>
                            <!-- <option value="Canceled" style="color: aliceblue;" <%= order.orderStatus === 'Canceled' ? 'selected' : '' %>>Canceled</option>
                            <option value="order returned" style="color: aliceblue;" <%= order.orderStatus === 'order returned' ? 'selected' : '' %>>order returned</option> -->
                            <%} else if(order.orderStatus == 'delivered') {%>
                                <option value="delivered" style="color: aliceblue;" <%= order.orderStatus === 'delivered' ? 'selected' : '' %>>Delivered</option>
                                <option value="order returned" style="color: aliceblue;" <%= order.orderStatus === 'order returned' ? 'selected' : '' %>>Return</option>
                                <% } else if(order.orderStatus == 'Canceled') {%>
                                    <option value="Canceled" style="color: aliceblue;" <%= order.orderStatus === 'Canceled' ? 'selected' : '' %>>Canceled</option>
                                    <% } else if(order.orderStatus == 'order returned') {%>
                                        <option value="order returned" style="color: aliceblue;" <%= order.orderStatus === 'order returned' ? 'selected' : '' %>>Returned</option>
                                        <% } %>
                        </select>
                    </p>
                    <input type="hidden" name="orderId" value="<%= order._id %>">
                    <button type="submit" class="btn btn-primary">Update Status</button>
                   
                </form>
            </div>
            <br>
            <h5>Order Items:</h5>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Product</th>
                            <th>Image</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Discount</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% 
                        let totalOrderCost = 0;
                        order.orderItems.forEach((item, index) => { 
                            totalOrderCost += parseFloat(item.totalAmount);
                        %>
                        <tr>
                            <td style="color: aliceblue;"><%= index + 1 %></td>
                            <td style="color: aliceblue;"><%= item.productDetails ? item.productDetails.name : 'N/A' %></td>
                            <td>
                                <% if (item.productDetails && item.productDetails.image) { %>
                                    <img src="/static/productImages/<%= item.productDetails.image[0] %>" alt="Product Image" style="width: 80px; height: 100px; border-radius: 0%;">
                                <% } else { %>
                                    N/A
                                <% } %>
                            </td>
                            <td style="color: aliceblue;"><%= item.quantity %></td>
                            <td style="color: aliceblue;">₹<%= item.price.toFixed(2) %></td>
                            <td style="color: aliceblue;">₹<%= item.discountPrice %></td>
                            <td style="color: aliceblue;">₹<%= item.totalAmount %></td>
                        </tr>
                        <% }) %>
                    </tbody>
                    <tfoot>
                        <tr>
                          
                                <th>Coupon adiscount:</th>
                                <% 
                                let res = 0;
                                order.orderItems.forEach((item) => { 
                                    let itemTotal = parseFloat(item.totalAmount) || 0;
                                    res += itemTotal;
                                }); 
                                let orderAmount = parseFloat(order.amount) || 0;
                                let res2 = (res - orderAmount).toFixed(2);
                            %>
                            <th>
                                <%= res2 %>
                            </th>
                            
                                
                            <th colspan="4" style="text-align:right">Total Order Cost:</th>
                            <th>₹<%= order.amount.toFixed(2) %></th>
                        </tr>
                    </tfoot>
                </table>
            </div><br>
            <a href="/admin/orders" class="btn btn-primary">Back to Orders</a>
        </div>
    </div>
</div>




<%- include('./adminFooter.ejs') %>